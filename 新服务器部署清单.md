# æ–°æœåŠ¡å™¨éƒ¨ç½²æ¸…å•

## ğŸ“Š æœåŠ¡å™¨å¯¹æ¯”åˆ†æ

### ç”Ÿäº§æœåŠ¡å™¨ (47.115.94.203) - âœ… å®Œæ•´éƒ¨ç½²
- âœ… Node.js 18+
- âœ… Nginx åå‘ä»£ç†
- âœ… PM2 è¿›ç¨‹ç®¡ç†å™¨
- âœ… é¡¹ç›®åç«¯ä»£ç  (douyin-admin-master)
- âœ… å‰ç«¯é™æ€æ–‡ä»¶ (html/)
- âœ… SQLiteæ•°æ®åº“ (database.sqlite)
- âœ… SSLè¯ä¹¦ (Let's Encrypt)
- âœ… ç¯å¢ƒå˜é‡é…ç½®
- âœ… ç³»ç»ŸæœåŠ¡é…ç½®

### æ–°æœåŠ¡å™¨ (112.74.163.102) - âœ… SSLè¯ä¹¦é…ç½®å®Œæˆ
- âœ… Node.js 20.19.5 - å·²å‡çº§å¹¶å®‰è£…
- âœ… Nginx 1.18.0 - å·²å®‰è£…å¹¶è¿è¡Œ
- âœ… PM2 6.0.13 - å·²å®‰è£…å¹¶è¿è¡ŒæœåŠ¡
- âœ… é¡¹ç›®åç«¯ä»£ç  - å·²éƒ¨ç½² (/var/www/douyin-admin-master/)
- âœ… å‰ç«¯é™æ€æ–‡ä»¶ - å·²éƒ¨ç½² (/var/www/html/)
- âœ… SQLiteæ•°æ®åº“ - å·²åˆå§‹åŒ– (135KB, 5ä¸ªè¡¨)
- âœ… ç¯å¢ƒå˜é‡ - å·²é…ç½® (.envæ–‡ä»¶)
- âœ… SSLè¯ä¹¦ - å·²é…ç½® (Let's Encryptè¯ä¹¦)
- âœ… ç³»ç»ŸæœåŠ¡ - Nginxå’ŒPM2è¿è¡Œæ­£å¸¸

## ğŸš€ æ–°æœåŠ¡å™¨éƒ¨ç½²æ­¥éª¤

### 1. å®‰è£…ç³»ç»Ÿè½¯ä»¶
```bash
# æ›´æ–°ç³»ç»Ÿ
sudo apt update && sudo apt upgrade -y

# å®‰è£…åŸºç¡€å·¥å…·
sudo apt install -y curl wget git unzip software-properties-common

# å®‰è£…Node.js 18+
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt install -y nodejs

# å®‰è£…Nginx
sudo apt install -y nginx

# å®‰è£…PM2
sudo npm install -g pm2

# å®‰è£…SQLite3
sudo apt install -y sqlite3

# å®‰è£…Python (ç”¨äºcertbot)
sudo apt install -y python3 python3-pip

# å®‰è£…Let's Encrypt certbot
sudo apt install -y certbot python3-certbot-nginx
```

### 2. é…ç½®SSHå¯†é’¥è®¤è¯
```bash
# åœ¨æ–°æœåŠ¡å™¨ä¸Šè¿è¡ŒSSHè®¾ç½®è„šæœ¬
scp setup-server-ssh.sh root@112.74.163.102:~/
ssh root@112.74.163.102
chmod +x setup-server-ssh.sh
./setup-server-ssh.sh

# æœ¬åœ°é…ç½®SSH
# ç¼–è¾‘ ~/.ssh/config æ·»åŠ ï¼š
Host new-server
    HostName 112.74.163.102
    User root
    IdentityFile ~/.ssh/id_rsa_new_server
    IdentitiesOnly yes

# æµ‹è¯•è¿æ¥
ssh new-server
```

### 3. åˆ›å»ºé¡¹ç›®ç›®å½•
```bash
# åœ¨æ–°æœåŠ¡å™¨ä¸Š
sudo mkdir -p /var/www
cd /var/www
```

### 4. éƒ¨ç½²é¡¹ç›®ä»£ç 
```bash
# ä»æœ¬åœ°ä¸Šä¼ é¡¹ç›®ä»£ç 
scp -r src/ root@112.74.163.102:/var/www/douyin-admin-master
scp server.js root@112.74.163.102:/var/www/douyin-admin-master/
scp package.json root@112.74.163.102:/var/www/douyin-admin-master/
# ä¸Šä¼ å…¶ä»–å¿…è¦æ–‡ä»¶...
```

### 5. é…ç½®ç¯å¢ƒå˜é‡
```bash
# åœ¨æ–°æœåŠ¡å™¨ä¸Šåˆ›å»º.envæ–‡ä»¶
cd /var/www/douyin-admin-master
sudo cp .env.example .env  # å¦‚æœå­˜åœ¨çš„è¯

# ç¼–è¾‘.envæ–‡ä»¶
sudo nano .env

# æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š
JWT_SECRET=your-super-secure-jwt-secret-key-here
PORT=3000
DB_TYPE=sqlite
NODE_ENV=production
VITE_DOUYIN_APP_ID=your-douyin-app-id
VITE_DOUYIN_APP_SECRET=your-douyin-app-secret
```

### 6. åˆå§‹åŒ–æ•°æ®åº“
```bash
cd /var/www/douyin-admin-master

# å®‰è£…ä¾èµ–
npm install --production

# åˆå§‹åŒ–æ•°æ®åº“
node scripts/init-db.js

# åˆå§‹åŒ–é»˜è®¤token
node scripts/init-tokens.js

# åˆ›å»ºç®¡ç†å‘˜ç”¨æˆ·
node -e "
const { sequelize } = require('./config/database');
const User = require('./models/User')(sequelize);

async function createAdmin() {
  try {
    await sequelize.sync();
    const admin = await User.createUser({
      username: 'admin',
      password: 'Admin123!',
      name: 'ç³»ç»Ÿç®¡ç†å‘˜',
      role: 'admin'
    });
    console.log('ç®¡ç†å‘˜åˆ›å»ºæˆåŠŸ:', admin.username);
    process.exit(0);
  } catch (error) {
    console.error('åˆ›å»ºç®¡ç†å‘˜å¤±è´¥:', error);
    process.exit(1);
  }
}
createAdmin();
"
```

### 7. é…ç½®Nginxåå‘ä»£ç†
```bash
# åˆ›å»ºNginxé…ç½®æ–‡ä»¶
sudo nano /etc/nginx/sites-available/ecpm-app

# å¤åˆ¶nginx-config-tempå†…å®¹åˆ°é…ç½®æ–‡ä»¶

# å¯ç”¨ç«™ç‚¹
sudo ln -s /etc/nginx/sites-available/ecpm-app /etc/nginx/sites-enabled/
sudo rm /etc/nginx/sites-enabled/default

# æµ‹è¯•é…ç½®
sudo nginx -t

# é‡å¯Nginx
sudo systemctl reload nginx
```

### 8. éƒ¨ç½²å‰ç«¯åº”ç”¨
```bash
# æœ¬åœ°æ„å»ºå‰ç«¯
npm run build

# ä¸Šä¼ å‰ç«¯æ–‡ä»¶åˆ°æ–°æœåŠ¡å™¨
scp -r dist/* root@112.74.163.102:/var/www/html/

# è®¾ç½®æƒé™
sudo chown -R www-data:www-data /var/www/html
sudo chmod -R 755 /var/www/html
```

### 9. å¯åŠ¨åç«¯æœåŠ¡
```bash
cd /var/www/douyin-admin-master

# åˆ›å»ºPM2é…ç½®æ–‡ä»¶
cat > ecosystem.config.js << EOF
module.exports = {
  apps: [{
    name: 'douyin-admin',
    script: 'server.js',
    instances: 1,
    autorestart: true,
    watch: false,
    max_memory_restart: '1G',
    env: {
      NODE_ENV: 'production',
      PORT: 3000
    },
    error_file: '/var/log/pm2/douyin-admin-error.log',
    out_file: '/var/log/pm2/douyin-admin-out.log',
    log_file: '/var/log/pm2/douyin-admin.log'
  }]
};
EOF

# å¯åŠ¨æœåŠ¡
pm2 start ecosystem.config.js

# è®¾ç½®å¼€æœºè‡ªå¯
pm2 startup
pm2 save
```

### 10. é…ç½®SSLè¯ä¹¦
```bash
# åœæ­¢Nginx
sudo systemctl stop nginx

# ç”³è¯·è¯ä¹¦ (æ›¿æ¢ä¸ºä½ çš„åŸŸå)
sudo certbot certonly --standalone -d your-domain.com -d www.your-domain.com

# å¯åŠ¨Nginx
sudo systemctl start nginx

# æµ‹è¯•ç»­æœŸ
sudo certbot renew --dry-run
```

### 11. è®¾ç½®ç›‘æ§å’Œå¤‡ä»½
```bash
# åˆ›å»ºç›‘æ§è„šæœ¬
sudo nano /var/www/monitor.sh

# æ·»åŠ ç›‘æ§å†…å®¹...

# åˆ›å»ºå¤‡ä»½è„šæœ¬
sudo nano /var/www/backup_script.sh

# æ·»åŠ å¤‡ä»½é€»è¾‘...

# è®¾ç½®å®šæ—¶ä»»åŠ¡
sudo crontab -e

# æ·»åŠ ï¼š
# æ¯å°æ—¶ç›‘æ§
0 * * * * /var/www/monitor.sh >> /var/log/system-monitor.log 2>&1

# æ¯å¤©å¤‡ä»½
0 2 * * * cp /var/www/douyin-admin-master/database.sqlite /var/www/database_daily_$(date +\%Y\%m\%d).sqlite
```

### 12. æµ‹è¯•éƒ¨ç½²ç»“æœ
```bash
# æµ‹è¯•æœåŠ¡çŠ¶æ€
pm2 status
sudo systemctl status nginx

# æµ‹è¯•API
curl http://localhost:3000/api/health
curl https://your-domain.com/api/health

# æµ‹è¯•å‰ç«¯
curl -I https://your-domain.com
```

## ğŸ“‹ å¿«é€Ÿéƒ¨ç½²è„šæœ¬

### è‡ªåŠ¨éƒ¨ç½²è„šæœ¬ (æ¨è)
```bash
# åˆ›å»ºéƒ¨ç½²è„šæœ¬
sudo nano /var/www/deploy-new-server.sh

# æ·»åŠ å®Œæ•´éƒ¨ç½²é€»è¾‘...

# æ‰§è¡Œéƒ¨ç½²
chmod +x /var/www/deploy-new-server.sh
/var/www/deploy-new-server.sh
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å¤‡ä»½é‡è¦æ•°æ®** - éƒ¨ç½²å‰å¤‡ä»½ç”Ÿäº§æœåŠ¡å™¨æ•°æ®
2. **åŸŸåé…ç½®** - ç¡®ä¿åŸŸåDNSæŒ‡å‘æ–°æœåŠ¡å™¨IP
3. **é˜²ç«å¢™é…ç½®** - é…ç½®UFWå¼€æ”¾å¿…è¦ç«¯å£
4. **å®‰å…¨åŠ å›º** - ä¿®æ”¹SSHé…ç½®ï¼Œç¦ç”¨rootå¯†ç ç™»å½•
5. **ç›‘æ§å‘Šè­¦** - è®¾ç½®æœåŠ¡ç›‘æ§å’Œé”™è¯¯å‘Šè­¦

## ğŸ” éªŒè¯æ¸…å•

- [x] Node.jsç‰ˆæœ¬æ­£ç¡® (20.19.5)
- [x] Nginxé…ç½®æ­£ç¡®å¹¶è¿è¡Œ
- [x] PM2æœåŠ¡è¿è¡Œæ­£å¸¸ (douyin-admin-apiåœ¨çº¿)
- [x] æ•°æ®åº“æ–‡ä»¶å­˜åœ¨ (135KB, 5ä¸ªè¡¨)
- [x] å‰ç«¯æ–‡ä»¶å®Œæ•´ (/var/www/html/)
- [x] ç¯å¢ƒå˜é‡é…ç½®æ­£ç¡® (JWT_SECRET, DB_TYPEç­‰)
- [x] SSLè¯ä¹¦æœ‰æ•ˆ (Let's Encryptè¯ä¹¦ï¼ŒHTTPSè®¿é—®æ­£å¸¸ï¼ŒHTTPè‡ªåŠ¨é‡å®šå‘)
- [x] APIæ¥å£å¯è®¿é—® (å¥åº·æ£€æŸ¥æ­£å¸¸)
- [x] å‰ç«¯é¡µé¢æ­£å¸¸åŠ è½½ (HTTPSè¿”å›HTMLå†…å®¹)
- [ ] ç”¨æˆ·ç™»å½•åŠŸèƒ½æ­£å¸¸ (éœ€è¦é‡æ–°ç™»å½•ï¼ŒJWTå¯†é’¥å·²æ›´æ”¹)

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚é‡é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
1. ç³»ç»Ÿæ—¥å¿—ï¼š`sudo journalctl -u nginx`
2. PM2æ—¥å¿—ï¼š`pm2 logs douyin-admin`
3. åº”ç”¨æ—¥å¿—ï¼šæ£€æŸ¥ `/var/log/pm2/` ç›®å½•
4. ç½‘ç»œè¿æ¥ï¼š`curl localhost:3000/api/health`